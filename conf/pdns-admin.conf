# Autor: Robson Vaamonde
# Site: www.procedimentosemti.com.br
# Facebook: facebook.com/ProcedimentosEmTI
# Facebook: facebook.com/BoraParaPratica
# YouTube: youtube.com/BoraParaPratica
# Linkedin: https://www.linkedin.com/in/robson-vaamonde-0b029028/
# Instagram: https://www.instagram.com/procedimentoem/?hl=pt-br
# Data de criação: 07/10/2025
# Data de atualização: 07/10/2025
# Versão: 0.01
# Testado e homologado para a versão do Ubuntu Server 22.04.x LTS x64x
# Testado e homologado para a versão do PowerDNS Admin v0.4.2
#
# Configuração do site virtual do PowerDNS Admin no NGINX Server
#
server {
    # Porta padrão HTTP IPv4 e IPv6 em Dual Stack
    listen *:80;
    listen [::]:80 ipv6only=off;

    # Nome do servidor (ajuste conforme o domínio ou subdomínio utilizado)
    server_name pdns.pti.intra;

    # Arquivos padrão indexados e diretório raiz do PowerDNS-Admin
    index index.html index.htm index.php;
    root  /var/www/html/pdns;

    # Logs de acesso e de erros do NGINX para o PowerDNS-Admin
    access_log /var/log/nginx/pdnsadmin_access.log combined;
    error_log  /var/log/nginx/pdnsadmin_error.log;

    ###############################################################################
    # Configurações gerais de proxy e buffers
    # Estas diretivas controlam o tamanho máximo de upload, tempo de conexão
    # e comportamento de cache e cabeçalhos durante o proxy.
    ###############################################################################
    client_max_body_size           10m;    # Limite máximo de upload de arquivos
    client_body_buffer_size        128k;   # Tamanho do buffer para corpo das requisições
    proxy_redirect                 off;    # Evita redirecionamento automático
    proxy_connect_timeout          90;     # Tempo limite de conexão com o backend Flask
    proxy_send_timeout             90;     # Tempo máximo de envio de dados para o backend
    proxy_read_timeout             90;     # Tempo máximo para leitura de resposta
    proxy_buffers                  32 4k;  # Quantidade e tamanho dos buffers de resposta
    proxy_buffer_size              8k;     # Buffer para cabeçalhos de resposta
    proxy_headers_hash_bucket_size 64;     # Otimiza a manipulação de cabeçalhos HTTP

    # Cabeçalhos repassados ao backend (Flask)
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;

    ###############################################################################
    # Bloco responsável pelos arquivos estáticos (CSS, JS, imagens)
    # Esses arquivos são servidos diretamente pelo NGINX, sem passar pelo Flask.
    ###############################################################################
    location ~ ^/static/ {
        include /etc/nginx/mime.types;
        root /var/www/html/pdns/powerdnsadmin;

        # Cache longo para imagens (365 dias)
        location ~* \.(jpg|jpeg|png|gif)$ {
            expires 365d;
        }

        # Cache curto para arquivos de estilo e scripts (7 dias)
        location ~* ^.+\.(css|js)$ {
            expires 7d;
        }
    }

    ###############################################################################
    # Bloco principal - redireciona todas as outras requisições para o Flask
    # O PowerDNS-Admin roda via gunicorn e se comunica através do socket UNIX.
    ###############################################################################
    location / {
        proxy_pass            http://unix:/run/pdnsadmin/socket;
        proxy_read_timeout    120;
        proxy_connect_timeout 120;
        proxy_redirect        off;
    }
}
