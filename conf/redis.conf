# Autor: Robson Vaamonde
# Site: www.procedimentosemti.com.br
# Facebook: facebook.com/ProcedimentosEmTI
# Facebook: facebook.com/BoraParaPratica
# YouTube: youtube.com/BoraParaPratica
# Linkedin: https://www.linkedin.com/in/robson-vaamonde-0b029028/
# Instagram: https://www.instagram.com/procedimentoem/?hl=pt-br
# Data de criação: 05/10/2025
# Data de atualização: 05/10/2025
# Versão: 0.01
# Testado e homologado para a versão do Ubuntu Server 22.04.x LTS x64x
# Testado e homologado para a versão do Redis Server v6.0.x
#
# Configuração básica do Serviço do Redis Server no Ubuntu Server
#
########## REDE E CONEXÃO ##########
# Interface de escuta (localhost por segurança)
bind 127.0.0.1 ::1

# Proteção contra conexões externas não autenticadas
protected-mode yes

# Porta padrão do Redis
port 6379

# Fila máxima de conexões pendentes
tcp-backlog 511

# Tempo limite para desconectar clientes inativos (0 = desativado)
timeout 0

# Tempo para enviar pacotes de keepalive TCP
tcp-keepalive 300

########## PROCESSO E EXECUÇÃO ##########
# Executar como serviço (daemon)
daemonize yes

# Supervisão (para systemd, altere para: supervised systemd)
supervised no

# Caminho do arquivo PID
pidfile /var/run/redis/redis-server.pid

# Nível de log (debug, verbose, notice, warning)
loglevel notice

# Arquivo de log principal
logfile /var/log/redis/redis-server.log

# Quantidade de bancos de dados lógicos
databases 16

# Exibe o logotipo ASCII no log
always-show-logo yes

########## PERSISTÊNCIA (RDB) ##########
# Salvamentos automáticos (segundos / alterações)
save 900 1
save 300 10
save 60 10000

# Interrompe gravações se o snapshot falhar
stop-writes-on-bgsave-error yes

# Comprimir snapshots
rdbcompression yes

# Verificação de integridade (checksum)
rdbchecksum yes

# Nome do arquivo RDB
dbfilename dump.rdb

# Diretório onde RDB/AOF são armazenados
dir /var/lib/redis

########## REPLICAÇÃO ##########
# Permite que réplicas sirvam dados desatualizados
replica-serve-stale-data yes

# Réplica somente leitura
replica-read-only yes

# Desativa sync sem disco
repl-diskless-sync no

# Tempo de espera para iniciar sync sem disco
repl-diskless-sync-delay 5

# Carga inicial em modo diskless
repl-diskless-load disabled

# Define prioridade de réplica
replica-priority 100

########## AOF (APPEND ONLY FILE) ##########
# Desativado por padrão
appendonly no

# Nome do arquivo AOF
appendfilename "appendonly.aof"

# Frequência de sincronização (always, everysec, no)
appendfsync everysec

# Não desativar sync durante reescrita
no-appendfsync-on-rewrite no

# Reescreve AOF quando dobra de tamanho
auto-aof-rewrite-percentage 100

# Tamanho mínimo para reescrita
auto-aof-rewrite-min-size 64mb

# Carrega AOF truncado
aof-load-truncated yes

# Usa preâmbulo RDB para AOF
aof-use-rdb-preamble yes

########## SCRIPTS E DESEMPENHO ##########
# Tempo máximo de execução de scripts Lua (ms)
lua-time-limit 5000

# Limite para comandos lentos (µs)
slowlog-log-slower-than 10000

# Máximo de entradas no slowlog
slowlog-max-len 128

# Desativa monitoramento de latência (0 = off)
latency-monitor-threshold 0

########## ESTRUTURAS INTERNAS ##########
# Otimizações para estruturas pequenas
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
hll-sparse-max-bytes 3000
stream-node-max-bytes 4096
stream-node-max-entries 100

########## OTIMIZAÇÃO DE MEMÓRIA ##########
# Ativa rehash automático
activerehashing yes

# Limites de buffer por tipo de cliente
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Frequência das tarefas internas
hz 10
dynamic-hz yes

# Ativa fsync incremental em AOF e RDB
aof-rewrite-incremental-fsync yes
rdb-save-incremental-fsync yes

# Ativa thread de background para alocador jemalloc
jemalloc-bg-thread yes

########## SEGURANÇA ##########
# Senha opcional para acesso (descomente se necessário)
# requirepass senha_forte_aqui

# Controle de log de ACL
acllog-max-len 128

########## AJUSTE DE MEMÓRIA (OOM) ##########
# Ajuste de prioridade no OOM Killer
oom-score-adj no
oom-score-adj-values 0 200 800

########## EVENTOS E NOTIFICAÇÕES ##########
# Eventos de keyspace (ex: "Ex", "Kx", etc)
notify-keyspace-events ""

########## AJUSTES AVANÇADOS ##########
# Reescrita e expiração assíncronas desativadas
lazyfree-lazy-eviction no
lazyfree-lazy-expire no
lazyfree-lazy-server-del no
replica-lazy-flush no
lazyfree-lazy-user-del no