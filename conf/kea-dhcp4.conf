// Autor: Robson Vaamonde
// Site: www.procedimentosemti.com.br
// Facebook: facebook.com/ProcedimentosEmTI
// Facebook: facebook.com/BoraParaPratica
// YouTube: youtube.com/BoraParaPratica
// Linkedin: https://www.linkedin.com/in/robson-vaamonde-0b029028/
// Instagram: https://www.instagram.com/procedimentoem/?hl=pt-br
// Data de criação: 20/11/2025
// Data de atualização: 24/11/2025
// Versão: 0.07
// Testado e homologado para a versão do Ubuntu Server 22.04.x LTS x64x
// Testado e homologado para a versão do Kea DHCP4 Server v3.0.x
//
// ====== BLOCO DE CONFIGURAÇÃO PADRÃO DO KEA DHCP4 SERVER ======

{
 "Dhcp4": {

    // ---------------------------------------------------------
    // Interfaces de Rede nas quais o Kea vai responder DHCPv4
    // ---------------------------------------------------------
    "interfaces-config": {
        "interfaces": [ "enp0s3" ]
    },

    // ---------------------------------------------------------
    // Control Socket (permite administração via API/kea-shell)
    // ---------------------------------------------------------
    "control-socket": {
        "socket-type": "unix",
        "socket-name": "/var/run/kea/kea4-ctrl-socket"
    },

    // --------------------------------------------------------
    // Configuração da integração do Kea DHCP4 Server e DDNS 
    // --------------------------------------------------------
    "dhcp-ddns": {
         "enable-updates": true,
         "server-ip": "127.0.0.1",
         "server-port": 53001,
         "sender-ip": "",
         "sender-port": 0,
         "max-queue-size": 1024,
         "ncr-protocol": "UDP",
         "ncr-format": "JSON"
     },

     "ddns-qualifying-suffix": "pti.intra",
     "ddns-override-client-update": true,

    // A partir do Kea 2.7.4, a biblioteca de hooks libdhcp_pgsql.so deve ser carregada para
    // armazenar reservas de host no backend de banco de dados PostgreSQL.
    // Especifique o local da biblioteca de hooks do backend de host.
    "hooks-libraries": [
      {
        "library": "/usr/lib/x86_64-linux-gnu/kea/hooks/libdhcp_pgsql.so"
      },
      {
        "library": "/usr/lib/x86_64-linux-gnu/kea/hooks/libdhcp_stat_cmds.so"
      },
      {
        "library": "/usr/lib/x86_64-linux-gnu/kea/hooks/libdhcp_host_cmds.so"
      },
      {
        "library": "/usr/lib/x86_64-linux-gnu/kea/hooks/libdhcp_lease_cmds.so"
      },
      {
        "library": "/usr/lib/x86_64-linux-gnu/kea/hooks/libdhcp_subnet_cmds.so"
      }
    ],

    // ---------------------------------------------------------
    // Banco de Leases (memfile = arquivo local, ideal para testes)
    // Banco de Leases (postgresql = banco de dados, ideal para grandes redes)
    // lfc-interval = intervalo do cleaner de leases expirados
    // ---------------------------------------------------------
    "lease-database": {
        "lfc-interval": 3600,
        // Bloco de configuração do Banco de Dados Memfile (Desativado)
        //"type": "memfile",
        //"persist": true,
        //"name": "dhcp4.leases",
        // Bloco de configuração do Banco de Dados PostgreSQL
        "type": "postgresql",
        "name": "keaserver",
        "user": "keaserver",
        "password": "keaserver",
        "host": "127.0.0.1",
        "port": 5432
    },

    // ---------------------------------------------------------
    // Processamento de leases expirados
    // ---------------------------------------------------------
    "expired-leases-processing": {
        "reclaim-timer-wait-time": 10,
        "flush-reclaimed-timer-wait-time": 25,
        "hold-reclaimed-time": 3600,
        "max-reclaim-leases": 100,
        "max-reclaim-time": 250,
        "unwarned-reclaim-cycles": 5
    },

    // ---------------------------------------------------------
    // Timers DHCP (S1, S2 e validade total)
    // ---------------------------------------------------------
    "renew-timer": 900,        // T1 → Renewal
    "rebind-timer": 1800,      // T2 → Rebinding
    "valid-lifetime": 3600,    // Tempo total do lease

    // ---------------------------------------------------------
    // Opções globais para toda a rede
    // ---------------------------------------------------------
    "option-data": [
        {
            "name": "domain-name-servers",
            "data": "8.8.8.8, 8.8.4.4"
        },
        {
            "name": "domain-name",
            "data": "pti.intra"
        },
        {
            "name": "domain-search",
            "data": "pti.intra"
        },
        {
            "name": "dhcp-server-identifier",
            "data": "172.16.1.20"
        }
    ],

    // ---------------------------------------------------------
    // Subnets configuradas
    // ---------------------------------------------------------
    "subnet4": [
        {
            // Identificação da Sub-rede 
            "id": 1,
            "subnet": "172.16.1.0/24",

            // Faixa de IPs dinâmicos (Range)
            "pools": [
                { "pool": "172.16.1.100 - 172.16.1.200" }
            ],

            // Roteador padrão (Gateway)
            "option-data": [
                {
                    "name": "routers",
                    "data": "172.16.1.254"
                }
            ],

            // Habilita modo autoritativo
            "authoritative": true,

            // Reservas estáticas (binds)
            "reservations": [
                {
                    "hw-address": "1a:1b:1c:1d:1e:1f",
                    "ip-address": "172.16.1.201"
                }
            ]
        }
    ],

    // ---------------------------------------------------------
    // Logging do serviço DHCP4
    // ---------------------------------------------------------
    "loggers": [
        {
            "name": "kea-dhcp4",
            "output-options": [
                {
                    "output": "/var/log/kea/kea-dhcp4.log",
                    "pattern": "%-5p %m\n"
                }
            ],
            "severity": "INFO",
            "debuglevel": 0
        }
    ]
 }
}
