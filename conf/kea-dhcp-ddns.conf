// Autor: Robson Vaamonde
// Site: www.procedimentosemti.com.br
// Facebook: facebook.com/ProcedimentosEmTI
// Facebook: facebook.com/BoraParaPratica
// YouTube: youtube.com/BoraParaPratica
// Linkedin: https://www.linkedin.com/in/robson-vaamonde-0b029028/
// Instagram: https://www.instagram.com/procedimentoem/?hl=pt-br
// Data de criação: 21/11/2025
// Data de atualização: 27/11/2025
// Versão: 0.03
// Testado e homologado para a versão do Ubuntu Server 22.04.x LTS x64x
// Testado e homologado para a versão do Kea DHCP DDNS v3.0.x
//
// ====== BLOCO DE CONFIGURAÇÃO PADRÃO DO KEA DHCP DDNS ======

{
  // ============================================================================
  //  CONFIGURAÇÃO DO ISC KEA DHCP-DDNS SERVER
  //  Responsável por receber os eventos do Kea DHCP4 e atualizar registros DNS
  //  compatível com PowerDNS Authoritative usando TSIG.
  // ============================================================================

  "DhcpDdns": {

    // ============================================================================
    //  ENDEREÇO E PORTA DO SERVIÇO DHCP-DDNS
    //  O DHCP4 se conecta neste IP/porta para enviar as atualizações DNS.
    //  Deve ser o mesmo configurado no dhcp4.conf
    // ============================================================================
    "ip-address": "127.0.0.1",
    "port": 53001,

    // ============================================================================
    //  SOCKET DE CONTROLE
    //  Permite comandos via kea-shell, Stork e automações.
    // ============================================================================
    "control-socket": {
      "socket-type": "unix",
      "socket-name": "/var/run/kea/kea-ddns-ctrl-socket"
    },

    // A partir do Kea 2.7.4, a biblioteca de hooks libdhcp_pgsql.so deve ser carregada para
    // armazenar reservas de host no backend de banco de dados PostgreSQL.
    // Especifique o local da biblioteca de hooks do backend de host.
    "hooks-libraries": [
      {
        "library": "/usr/lib/x86_64-linux-gnu/kea/hooks/libdhcp_ddns_tuning.so"
      }
    ],

    // ============================================================================
    //  CHAVES TSIG UTILIZADAS PARA ASSINAR AS ATUALIZAÇÕES DNS
    //  Deve corresponder exatamente à chave cadastrada no PowerDNS.
    //  ATENÇÃO: o "secret" deve ser Base64, utilizar o comando abaixo:
    //  echo "dhcp-key" | base64 (copiar e colar a chave gerada)
    //  Comando utilizado no PowerDNS: sudo pdnsutil tsigkey generate dhcp-key HMAC-SHA256
    //  Listando as chaves TSIG: sudo pdnsutil tsigkey list
    //  Instalando a chave TSIG: sudo pdnsutil tsigkey activate pti.intra dhcp-key consumer
    //  Instalando a chave TSIG: sudo pdnsutil tsigkey activate 1.16.172.in-addr.arpa dhcp-key consumer
    //  Verificando as chaves das Zonas: sudp pdnsutil zone list-keys
    //  Reiniciar o serviço do PowerDNS: sudo pdns_control reload
    // ============================================================================
    "tsig-keys": [
      {
        "name": "dhcp-key",              // nome lógico da chave TSIG
        "algorithm": "HMAC-SHA256",      // algoritmo aceito pelo PowerDNS
        "secret": "/bMY96YMgfrV5TUtBM4tdoM1VIZdzWJTOzBCpqGrJrnB4FjTGwmABEgutIuTOx8ElnOdPgM5Bc65Q6dKJdfqNA=="     // chave secreta (base64)
      }
    ],

    // ============================================================================
    //  BLOCO DE ZONAS DIRETAS (FORWARD)
    //  Atualiza registros A/AAAA em zonas como: pti.intra.
    // ============================================================================
    "forward-ddns": {
      "ddns-domains": [
        {
          "name": "pti.intra.",          // zona DNS principal
          "key-name": "dhcp-key",        // nome da chave TSIG acima
          "dns-servers": [
            {
              "ip-address": "172.16.1.20" // Servidor PowerDNS Authoritative
              "port": 53
            }
          ]
        }
      ]
    },

    // ============================================================================
    //  BLOCO DE ZONAS REVERSAS (PTR)
    //  Atualiza registros PTR automaticamente
    //  Exemplo: 172.16.1.x = 1.16.172.in-addr.arpa.
    // ============================================================================
    "reverse-ddns": {
      "ddns-domains": [
        {
          "name": "1.16.172.in-addr.arpa.",  // zona reversa da rede 172.16.1.0/24
          "key-name": "dhcp-key",            // mesma chave TSIG
          "dns-servers": [
            {
              "ip-address": "172.16.1.20"   // Servidor PowerDNS Authoritative
              "port": 53
            }
          ]
        }
      ]
    },

    // ============================================================================
    //  LOGS DO SERVIÇO DHCP-DDNS
    //  Em ambiente de testes, você pode usar "DEBUG".
    //  Em produção, use "INFO" para reduzir ruido.
    // ============================================================================
    "loggers": [
      {
        "name": "kea-dhcp-ddns",

        // Local onde o Kea gravará os logs do DDNS
        "output-options": [
          {
            "output": "/var/log/kea/kea-dhcp-ddns.log",
            "pattern": "%-5p %m\n"     // formatação do log
          }
        ],

        // Nível de log (INFO recomendado em produção)
        "severity": "INFO",

        // Nível de debug: 0 a 99 (usar apenas em troubleshooting)
        "debuglevel": 0
      }
    ]
  }
}
